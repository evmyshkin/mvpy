# Выполнение миграций

- Документ описывает алгоритм формирования и накатки миграций таблиц БД и данных.
- В шаблонном проекте `Первичная настройка alembic` уже выполнена. 
- Если нужно поменять настройки, нужно обратиться к соответствующему шагу ниже.
- Миграции построены на асинхронном драйвере `asyncpg`

## Первичная настройка alembic

Инструкции ниже нужны только при первичной настройке `alembic` в чистом проекте. Делать шаги в этом параграфе повторно
не надо, это памятка:

1. Инит миграции:

```bash
alembic init -t async migrations
```

2. в `env.py` добавить строку (и импорты) для загрузки URL для подключения к БД:

```
config.set_main_option("sqlalchemy.url", DATABASE_URL)
```

3. Заполнить `target_metadata` ссылкой на метаданные базового класс БД вместо `None`:

```
target_metadata = BaseDBModel.metadata
```

4. В `alembic.ini` задан шаблон для названия миграций в настройке
   `file_template = %%(year)d_%%(month).2d_%%(day).2d_%%(slug)s`

5. В `script.py.mako` задан шаблон для создаваемых миграций, который вместо стандартных для Alembic `upgrade()` и
   `downgrade()` делегирует их выполнение более явным `schema_upgrade()` и `schema_downgrade()`. А для создания миграций
   данных их стоит указывать в специально добавленные в шаблон функции `data_uprade()` и `data_downgrade()`.

## Как формировать структурную миграцию

В `env.py` импортированы все модели таблиц из модуля в `db.models.__init__.py`. Чтобы миграция создалась для новой
таблицы, убедиться, что в `__init__.py` она импортирована. Затем выполнить:

```bash
alembic revision --autogenerate -m "<migration_description>"
```

Проверку получившейся миграции проводить в `migration/versions/<rev_id_миграции>`

## Как сфорировать миграцию данных

В отличие от структурной, миграция данных невозможна автоматически. Нужно вызвать команду на создание шаблона миграции и
затем писать запросы ручками:

```bash
alembic revision -m "<migration_description>"
```

## Как применить миграцию

Применить все миграции до последней:

```bash
alembic upgrade head
```

Применить миграцию до конкретного `rev-id` миграции:

```bash
alembic upgrade <rev_id_миграции>
```

## Как откатить миграцию

Откат на одну версию:

```bash
alembic downgrade -1
```

Откат до конкретного id миграции:

```bash
alembic downgrade <rev_id_миграции>
```

## Как пересоздать миграцию

Если последняя миграция не устроила, сначала откатываем текущую. Удаляем ее из `migration.versions`. Вносим правки в
код. Генерим новую. Накатываем ее. Повторяем процесс, пока не подойдет результат.

Если возникает ошибка вида `ERROR [alembic.util.messaging] Can't locate revision identified by '<migration_id>'`, значит
айдишник миграции надо еще потереть в БД в таблице `alembic_versions`. Но это значит, что где-то в алгоритме ранее был
косяк при удалении старой миграции.