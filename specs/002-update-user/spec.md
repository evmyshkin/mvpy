# Feature Specification: Update User via API

**Feature Branch**: `002-update-user`
**Created**: 2025-02-05
**Status**: Draft
**Input**: User description: "@specs/spec_prompts/specify_prompt.md"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Обновление информации о пользователе (Priority: P1)

Как пользователь API, я хочу иметь возможность обновлять информацию о существующих пользователях через API, чтобы поддерживать актуальность записей сотрудников в системе.

**Why this priority**: Это основная функциональность возможности - без неё система не может выполнять базовое требование по обновлению информации пользователя.

**Independent Test**: Полностью тестируется созданием пользователя, затем обновлением его информации через API-эндпоинт и проверкой сохранения изменений в системе. Deliveries immediate value by allowing user information maintenance.

**Acceptance Scenarios**:

1. **Given** существующий пользователь с email "john.doe@example.com", **When** клиент API отправляет PUT-запрос на эндпоинт обновления пользователя с first_name "John", last_name "Smith", password "NewSecure123" и email "john.smith@example.com", **Then** система возвращает статус 200 с объектом пользователя с отражёнными всеми изменениями
2. **Given** существующий пользователь, **When** клиент API отправляет PUT-запрос с изменением только first_name на "Jane", **Then** система обновляет только first_name и возвращает статус 200 с объектом пользователя, отображающим обновлённый first_name
3. **Given** существующий пользователь с email "test@example.com", **When** клиент API пытается обновить email на "existing@example.com", который принадлежит другому пользователю, **Then** система возвращает статус 400 с сообщением об ошибке, указывающим, что email уже существует
4. **Given** несуществующий ID пользователя, **When** клиент API отправляет PUT-запрос на эндпоинт обновления пользователя, **Then** система возвращает статус 404 с сообщением об ошибке, указывающим, что пользователь не найден
5. **Given** существующий пользователь, **When** клиент API отправляет PUT-запрос с невалидным форматом email "invalid-email", **Then** система возвращает статус 422 с сообщением об ошибке валидации
6. **Given** существующий пользователь, **When** клиент API отправляет PUT-запрос с first_name, содержащим цифры "John123", **Then** система возвращает статус 422 с сообщением об ошибке валидации, указывающим, что разрешены только буквы и дефисы
7. **Given** существующий пользователь, **When** клиент API отправляет PUT-запрос со слабым паролем "simple", **Then** система возвращает статус 422 с сообщением об ошибке валидации, указывающим требования к паролю
8. **Given** существующий пользователь, **When** клиент API успешно обновляет информацию пользователя, **Then** все изменения немедленно отражаются в последующих API-вызовах для этого пользователя

---

### Edge Cases

- Что происходит при попытке обновить ID пользователя, которого не существует в системе?
- Как система обрабатывает частичные обновления (предоставлены только некоторые поля)?
- Что происходит при попытке обновить email на тот, который уже занят другим пользователем?
- Как система обрабатывает специальные символы в полях имени (эмодзи, цифры, символы)?
- Что происходит, когда поле пароля предоставлено, но пустое или null?
- Что происходит при попытке обновить пользователя с malformed JSON в теле запроса?
- Как система обрабатывает экстремально длинные значения полей (например, имя из 1000 символов)?
- Что происходит при попытке обновить email на то же значение, которое уже есть (случай no-op)?
- Как система обрабатывает обновления во время проблем с подключением к базе данных?

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА принимать PUT-запросы для обновления существующих записей пользователей через API-эндпоинт
- **FR-002**: Система ДОЛЖНА валидировать предоставленные поля запроса (first_name, last_name, password, email) на корректность. Все поля опциональны для поддержки частичных обновлений согласно FR-013.
- **FR-003**: Система ДОЛЖНА валидировать формат email согласно стандартным правилам адресов электронной почты
- **FR-004**: Система ДОЛЖНА обеспечивать уникальность email среди всех пользователей в системе
- **FR-005**: Система ДОЛЖНА валидировать, что first_name и last_name содержат только буквы (кириллица или латиница) и дефисы
- **FR-006**: Система ДОЛЖНА валидировать требования к сложности пароля (минимум 8 символов, минимум одна заглавная буква, одна строчная буква и одна цифра)
- **FR-007**: Система ДОЛЖНА хешировать пароли с использованием безопасного алгоритма хеширования перед сохранением в базу данных
- **FR-008**: Система ДОЛЖНА возвращать HTTP статус 200 с полным обновлённым объектом пользователя (id, first_name, last_name, email) при успешном обновлении
- **FR-009**: Система ДОЛЖНА возвращать HTTP статус 404 при попытке обновить несуществующий ID пользователя
- **FR-010**: Система ДОЛЖНА возвращать HTTP статус 400 с описательным сообщением об ошибке, когда email уже существует в системе
- **FR-011**: Система ДОЛЖНА возвращать HTTP статус 422 с деталями ошибок валидации, когда данные запроса не проходят валидацию
- **FR-012**: Система ДОЛЖНА сохранять все валидированные изменения в базу данных немедленно при успешном обновлении
- **FR-013**: Система ДОЛЖНА поддерживать частичные обновления, позволяя изменять только определённые поля, сохраняя остальные
- **FR-014**: Система ДОЛЖНА возвращать все сообщения об ошибках валидации на русском языке в API ответах

### Key Entities

- **User**: Представляет сотрудника в системе с атрибутами: уникальный идентификатор, имя, фамилия, адрес электронной почты (должен быть уникальным) и безопасно хешированный пароль
- **Update Request**: Содержит данные пользователя для изменения, включая: имя, фамилию, пароль и адрес электронной почты
- **Update Response**: Возвращает обновлённую информацию пользователя, включая: идентификатор пользователя, имя, фамилию и адрес электронной почты (пароль никогда не возвращается в ответах)

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Клиенты API могут успешно обновить любую запись пользователя менее чем за 2 секунды
- **SC-002**: Система валидирует все поля ввода и возвращает соответствующие ответы об ошибках в течение 500 миллисекунд
- **SC-003**: 100% обновлений пароля приводят к безопасно хешированным паролям, сохранённым в базе данных (открытые пароли никогда не сохраняются)
- **SC-004**: Нулевое количество дубликатов email в системе после любого количества обновлений пользователей
- **SC-005**: Система возвращает правильные HTTP статусы для всех сценариев обновления (успех, не найден, ошибка валидации, дубликат email)
- **SC-006**: Операции обновления успешно завершаются, даже когда предоставлено только подмножество полей