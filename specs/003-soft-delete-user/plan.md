# План имплементации: Деактивация пользователя через API

**Ветка**: `003-soft-delete-user` | **Дата**: 2026-02-06 | **Спек**: [spec.md](./spec.md)
**Входные данные**: Спецификация функционала из `/specs/003-soft-delete-user/spec.md`

## Краткое описание

Добавление функциональности деактивации пользователей в существующий FastAPI сервис с сохранением данных для compliance-целей. Основная техническая задача: добавить поле `is_active` в модель User, реализовать DELETE-эндпоинт в API для установки `is_active=False`, обновить CRUD-операции для фильтрации неактивных пользователей и обеспечить обработку ошибок согласно требованиям.

## Технический контекст

**Язык/Версия**: Python 3.13 (согласно конституции, принцип I)
**Основные зависимости**: FastAPI, SQLAlchemy 2.0+, Pydantic V2, AsyncPG, Alembic, bcrypt 4.0.1 + passlib (согласно конституции, принцип I)
**Хранилище**: PostgreSQL 17 (согласно конституции, принцип I)
**Тестирование**: pytest с pytest-asyncio, Faker (согласно конституции, принцип VIII)
**Целевая платформа**: Linux/macOS сервер для REST API
**Тип проекта**: Web application (REST API сервис)
**Цели производительности**: Обработка запросов на удаление в течение 1 секунды (SC-001), ответы об ошибках в течение 500 мс (SC-003)
**Ограничения**: Асинхронная архитектура (AsyncIO), строго типизированный код, деактивация без потери данных
**Масштаб/Об Scope**: Одиночный эндпоинт DELETE, добавление 1 поля в модель User, изменения в 1 CRUD-классе, 1 сервисе, 1 контроллере

## Проверка конституции

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Принципы конституции для данной фичи

✅ **I. Технологический стек**: Python 3.13, FastAPI, SQLAlchemy 2.0+, Pydantic V2, Alembic, AsyncPG, PostgreSQL 17, bcrypt 4.0.1 + passlib - используется существующий стек

✅ **II. Dependency Injection**: Использование FastAPI Depends для асинхронных сессий БД в контроллерах

✅ **III. Type Annotations**: Строгая типизация всех функций и методов

✅ **IV. Управление конфигурацией**: Использование Pydantic Settings для конфигурации

✅ **V. Чистая архитектура**: Controller → Service → CRUD → DB разделение сохраняется

✅ **VI. Абстракция базовых классов**: Использование BaseDBModel, BaseCrud, BaseService без домен-специфичной логики в базовых классах

✅ **VII. Управление сессиями БД**: Использование `connector.get_session()` dependency

✅ **VIII. Требования к тестированию**: pytest-asyncio, Faker для тестовых данных, Pydantic модели для тестовых данных, покрытие ветвлений (--cov-branch)

✅ **IX. Стандарты качества кода**: Ruff, MyPy, Google-style docstrings на русском, pre-commit hooks

✅ **X. Дисциплина scoped-разработки**: Только деактивация (is_active=False), без функциональности реактивации и аудита "на будущее"

✅ **XI. Документация и локализация**: Русскоязычные `.md` файлы, docstring'и на русском, локализованные ошибки

✅ **XII. Принципы проектирования API**: DELETE-эндпоинт в `/api/v1/controllers/users.py`, использование starlette.status

✅ **XIII. Git-ветвление**: Ветка `003-soft-delete-user` со сквозной нумерацией

✅ **XIV. SQLAlchemy**: Использование `select()` вместо `query()` для получения данных с фильтрацией по is_active

✅ **XV. Дополнительная документация OpenAPI не нужна**: FastAPI генерирует автоматически, тестирование OpenAPI не требуется

✅ **XVI. Конфигурация окружений**: Разные URI для LOCAL/DEV/STAGE/PROD/PYTEST через connector

✅ **XVII. Код-стиль**: Именованные аргументы, тексты сообщений в Enum, импорты на уровне модуля

✅ **XVIII. Сервисный слой**: Использование Pydantic-схем в методах сервиса, передача данных через `model_dump()`

**Результат**: ✅ Все принципы конституции соблюдены. Нарушений нет.

## Структура проекта

### Документация (эта фича)

```text
specs/003-soft-delete-user/
├── spec.md              # Спецификация функционала
├── plan.md              # Этот файл (результат /speckit.plan)
├── research.md          # Phase 0 output (результат /speckit.plan)
├── data-model.md        # Phase 1 output (результат /speckit.plan)
├── quickstart.md        # Phase 1 output (результат /speckit.plan)
├── contracts/           # Phase 1 output (результат /speckit.plan)
│   └── openapi.yaml     # OpenAPI спецификация эндпоинта
├── checklists/          # Чеклисты качества
│   └── requirements.md  # Чеклист качества спецификации
└── tasks.md             # Phase 2 output (результат /speckit.tasks - НЕ создаётся в /speckit.plan)
```

### Исходный код (repository root)

```text
app/
├── db/
│   ├── models/
│   │   └── user.py                    # ОБНОВЛЕНИЕ: добавить is_active
│   └── crud/
│       ├── base.py                    # БЕЗ ИЗМЕНЕНИЙ: BaseCrud остаётся домен-независимым
│       └── users.py                   # ОБНОВЛЕНИЕ: обновить find_by_email для фильтрации по is_active
├── api/v1/
│   ├── controllers/
│   │   └── users.py                   # ОБНОВЛЕНИЕ: добавить DELETE /users/ эндпоинт
│   └── schemas/
│       └── users.py                   # БЕЗ ИЗМЕНЕНИЙ: схемы запросов/ответов (DELETE возвращает 204 без тела)
├── services/
│   ├── base.py                        # БЕЗ ИЗМЕНЕНИЙ: BaseService остаётся домен-независимым
│   └── user_service.py                # ОБНОВЛЕНИЕ: добавить метод deactivate_user()
└── main.py                            # БЕЗ ИЗМЕНЕНИЙ

tests/
├── api/v1/controllers/
│   └── test_users.py                  # ОБНОВЛЕНИЕ: добавить тесты для DELETE
├── services/
│   └── test_user_service.py           # ОБНОВЛЕНИЕ: добавить тесты для deactivate_user
└── conftest.py                        # БЕЗ ИЗМЕНЕНИЙ (возможно добавить фикстуры если нужно)

migrations/versions/
└── [new_migration].py                 # НОВАЯ миграция: добавить is_active в users
```

**Решение по структуре**: Web приложение (REST API сервис) с существующей чистой архитектурой Controller → Service → CRUD → DB. Все изменения локализованы в слоёв User (модель, CRUD, сервис, контроллер) без загрязнения базовых классов домен-специфичной логикой.

## Отслеживание сложности

> **Заполняется ТОЛЬКО если есть нарушения Constitution Check, которые должны быть обоснованы**

| Нарушение | Почему необходимо | Более простая альтернатива отклонена потому что |
|-----------|-------------------|--------------------------------------------------|
| НЕТ | - | Все решения соответствуют конституции |

---

# Phase 0: Research & Decisions

## Research Tasks

1. **Паттерн деактивации в SQLAlchemy**: Исследовать лучшие практики реализации деактивации с полем `is_active`
2. **HTTP статусы для DELETE-операций**: Определить правильные статусы (204 vs 200 vs 202) для деактивации
3. **Обработка race conditions**: Исследовать паттерны обработки одновременных запросов на деактивацию одного пользователя

**Результат**: research.md с решениями по всем задачам

---

# Phase 1: Design & Contracts

## Data Model Design

**Цель**: Добавить поле `is_active` в модель User для управления активностью пользователя

**Изменения**:
- Добавить `is_active: Mapped[bool]` - флаг активности (default=True)
- Обновить все CRUD-методы для фильтрации по `is_active=False`

**Импакт на миграцию**: Alembic миграция добавит 1 колонку `is_active` в таблицу `users` с default=True

## API Contracts

**Новый эндпоинт**:
- `DELETE /api/v1/users/{email}` - деактивация пользователя по email
  - Request: без тела (email в path)
  - Response: 204 No Content (пустое тело)
  - Errors: 404 Not Found (пользователь не существует или уже деактивирован)

**Обновления существующих**:
- `GET /api/v1/users/{id}` - автоматически фильтрует неактивных пользователей (404 если is_active=False)
- `PATCH /api/v1/users/{id}` - автоматически предотвращает обновление неактивных пользователей (404 если is_active=False)

**Результат**: OpenAPI спецификация в `contracts/openapi.yaml`

## Quickstart Guide

Инструкция для разработчиков по:
1. Применению миграции БД (добавление is_active)
2. Тестированию нового эндпоинта деактивации
3. Пониманию поведения деактивации (is_active=False)

**Результат**: quickstart.md с пошаговой инструкцией

## Agent Context Update

Обновить `.claude/custom_instructions.md` с новой информацией о деактивации пользователей

**Результат**: обновлённый agent context

---

# Phase 2: Implementation Tasks

*(Генерируется командой `/speckit.tasks` - не часть этого плана)*

**Ожидаемые задачи**:
1. Создать Alembic миграцию для добавления `is_active` в users
2. Обновить модель User с полем `is_active`
3. Добавить метод `deactivate_by_email` в UsersCrud
4. Обновить `find_by_email` для фильтрации неактивных пользователей (is_active=True) при необходимости
5. Добавить метод `deactivate_user` в UserService с бизнес-логикой
6. Добавить DELETE-эндпоинт в контроллер users
7. Написать тесты для API эндпоинта (успешная деактивация, пользователь не найден)
8. Написать тесты для сервиса (успешная деактивация, обработка ошибок)
9. Запустить `make test` и убедиться что все тесты проходят
10. Запустить `pre-commit run --all-files` для проверки качества кода