# Спецификация функционала: Деактивация пользователя через API

**Фича-ветка**: `003-soft-delete-user`
**Создана**: 2026-02-06
**Статус**: Черновик
**Входные данные**: Описание пользователя: "Мягкое удаление пользователя через API"

## Пользовательские сценарии и тестирование *(обязательно)*

### Пользовательская история 1 - Деактивация пользователя по email (Приоритет: P1)

Как системный администратор, я хочу деактивировать пользователя по его email-адресу, чтобы пользователь больше не мог получить доступ к системе, при этом сохраняя данные пользователя для целей соответствия требованиям и аудита.

**Почему этот приоритет**: Это основная функциональность фичи. Без возможности деактивации система не может безопасно управлять жизненным циклом пользователей, сохраняя данные для юридических/комплаенс требований. Это фундаментальная возможность управления пользователями.

**Автономная проверка**: Может быть полностью протестирована путём создания пользователя, вызова эндпоинта деактивации с email пользователя и проверки того, что пользователь деактивирован (is_active=False) и больше не может быть найден через стандартные операции API. Доставляет немедленную ценность, предотвращая несанкционированный доступ с сохранением данных.

**Сценарии приёмки**:

1. **Дано** активный пользователь с email "user@example.com существует, **Когда** система получает запрос на деактивацию "user@example.com", **Тогда** пользователь помечается как неактивный (is_active=False) и API отвечает статус-кодом 204 без содержимого
2. **Дано** активный пользователь с email "user@example.com существует, **Когда** пользователь был деактивирован, **Тогда** попытка обновить пользователя завершается неудачей
3. **Дано** деактивированный пользователь с email "user@example.com", **Когда** выполняется попытка аутентификации с этими учётными данными, **Тогда** аутентификация завершается неудачей с соответствующим сообщением об ошибке

---

### Пользовательская история 2 - Обработка деактивации несуществующего пользователя (Приоритет: P2)

Как системный администратор, я хочу получать чёткую обратную связь об ошибке при попытке деактивировать несуществующего пользователя, чтобы понимать, успешно ли выполнилась операция или нет.

**Почему этот приоритет**: Обработка ошибок критически важна для надёжности системы и пользовательского опыта администратора, но вторична по отношению к основной функциональности деактивации. Это улучшает удобство использования и предотвращает путаницу.

**Автономная проверка**: Может быть полностью протестирована путём попытки деактивировать email пользователя, которого не существует в системе, и проверки того, что возвращается соответствующий ответ об ошибке с чётким сообщением. Доставляет ценность за счёт улучшения опыта администратора.

**Сценарии приёмки**:

1. **Дано** не существует пользователя с email "nonexistent@example.com", **Когда** система получает запрос на деактивацию "nonexistent@example.com", **Тогда** API отвечает статус-кодом 404 и сообщением об ошибке, указывающим, что пользователь не найден
2. **Дано** пользователь был ранее деактивирован с email "deleted@example.com", **Когда** система получает повторный запрос на деактивацию "deleted@example.com", **Тогда** API отвечает статус-кодом 404, как если бы пользователя никогда не существовало

---

## Требования *(обязательно)*

### Функциональные требования

- **FR-001**: Система ДОЛЖНА принимать запросы на деактивацию через API-эндпоинт с email пользователя в качестве идентификатора
- **FR-002**: Система ДОЛЖНА помечать пользователя как неактивный (is_active=False) без физического удаления данных из базы данных
- **FR-003**: Система ДОЛЖНА отвечать HTTP статус-кодом 204 (No Content) при успешной деактивации
- **FR-004**: Система ДОЛЖНА предотвращать обновления деактивированных пользователей
- **FR-005**: Система ДОЛЖНА возвращать HTTP статус-код 404 (Not Found) при попытке деактивировать несуществующего пользователя
- **FR-006**: Система ДОЛЖНА предотвращать аутентификацию деактивированных пользователей
- **FR-007**: Система ДОЛЖНА проверять формат email перед обработкой запроса на деактивацию
- **FR-08**: Система ДОЛЖНА корректно обрабатывать ошибки подключения к базе данных во время операции деактивации

### Ключевые сущности

- **Пользователь (User)**: Представляет пользователя системы с атрибутами, включая email (уникальный идентификатор), имя, фамилию, хеш пароля и флаг активности (is_active). Связи с другими сущностями (если есть) сохраняются после деактивации.

## Критерии успеха *(обязательно)*

### Измеримые результаты

- **SC-001**: Администраторы могут успешно деактивировать любого активного пользователя через API вызов в течение 1 секунды
- **SC-002**: 100% операций деактивации сохраняют полные данные пользователя, включая все исторические записи и связи в базе данных
- **SC-003**: API предоставляет чёткие ответы об ошибках для попыток деактивации несуществующего пользователя в течение 500 миллисекунд
- **SC-004**: Нулевая потеря данных происходит во время операций деактивации - все записи пользователей остаются нетронутыми в базе данных

## Предположения

1. Email является уникальным идентификатором пользователей в системе
2. Деактивация - это состояние, функциональность реактивации в этой фиче пока не предусматривается
3. Системе не нужно отслеживать, кто выполнил деактивацию (нет журнала аудита действий администратора)
4. Данные деактивированных пользователей должны сохраняться неограниченно долго для целей соответствия требованиям
5. Каскадная деактивация для связанных сущностей (например, посты пользователя, комментарии и т. д.) не требуется
6. Аутентификация/авторизация API для эндпоинта деактивации будет прорабатываться позже, отдельно от этой функциональности
7. Флаг is_active=False - единственное дополнительное метаданное, необходимое для деактивации