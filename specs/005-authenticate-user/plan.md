# План реализации: Аутентификация и авторизация пользователей

**Ветка**: `005-authenticate-user` | **Дата**: 2025-02-06 | **Спек**: [spec.md](./spec.md)
**Входные данные**: Спецификация функции из `specs/005-authenticate-user/spec.md`

**Примечание**: Этот шаблон заполняется командой `/speckit.plan`. См. `.specify/templates/commands/plan.md` для рабочего процесса выполнения.

## Краткое описание

Реализация системы аутентификации и авторизации пользователей на основе JWT токенов. Функция включает три основные пользовательские истории: (P1) аутентификация по email и паролю с выдачей JWT токена, (P2) выход из системы с аннулированием токена, (P3) базовая авторизация с проверкой активного статуса пользователя при каждом запросе к защищённым эндпоинтам.

Технический подход: использование JWT (JSON Web Tokens) для stateless аутентификации, параметризуемая длина сессии через конфигурацию, интеграция с существующей системой пользователей (email, password_hash, is_active), использование FastAPI Depends для dependency injection и middleware для проверки авторизации.

## Технический контекст

**Язык/Версия**: Python 3.13 (обязательно по конституции)
**Основные зависимости**:
- FastAPI (фреймворк API)
- SQLAlchemy 2.0+ с AsyncPG (драйвер PostgreSQL)
- Pydantic V2 (валидация данных)
- python-jose[cryptography] (для JWT операций)
- passlib + bcrypt 4.0.1 (хеширование паролей, уже используется)

**Хранилище**: PostgreSQL 17 (уже используется для User модели)
**Тестирование**: pytest с pytest-asyncio (уже используется в проекте)
**Целевая платформа**: Linux/macOS сервер (FastAPI приложение)
**Тип проекта**: Web API (одностраничный бэкенд)
**Цели производительности**:
- Аутентификация: < 2 секунд (SC-001)
- Проверка токена: минимальный overhead (< 10ms)
- Поддержка 1000+ concurrent пользователей

**Ограничения**:
- Stateless аутентификация (не хранить сессии в БД для базовой функциональности)
- Токен должен содержать is_active на момент выдачи
- Длина сессии параметризуема в конфиге
- Обратная совместимость с существующей User моделью

**Масштаб/Область применения**:
- 3 новых эндпоинта (auth, logout, middleware для авторизации)
- 1 новая Pydantic схема для токена
- 1 новая модель BlacklistedToken (для отзыва токенов при logout)
- Интеграция с существующими пользовательскими эндпоинтами

## Проверка конституции

*GATE: Должно быть пройдено перед Phase 0 исследованием. Повторная проверка после Phase 1 дизайна.*

### Принципы конституции

#### ✅ I. Технологический стек
- **Python 3.13**: Да, указан в техническом контексте
- **FastAPI**: Да, используется как фреймворк API
- **SQLAlchemy 2.0+ с AsyncPG**: Да, для работы с User моделью
- **Pydantic V2**: Да, для валидации запросов/ответов
- **Alembic**: Да, потребуется миграция для BlacklistedToken модели
- **PostgreSQL 17**: Да, используется для хранения
- **bcrypt 4.0.1**: Да, уже используется в проекте
- **UV**: Да, используется как пакетный менеджер

**Результат**: ✅ PASS

#### ✅ II. Dependency Injection
- Использовать FastAPI Depends для inject зависимости сессии БД
- Создать dependency для получения текущего пользователя из токена

**План**: Да, все зависимости будут явно объявлены через Depends

**Результат**: ✅ PASS

#### ✅ III. Type Annotations
- Все функции и методы будут иметь строгую типизацию

**План**: Да, следовать существующим практикам в проекте

**Результат**: ✅ PASS

#### ✅ IV. Управление конфигурацией
- Добавить JWT_SECRET_KEY в конфигурацию
- Добавить JWT_ACCESS_TOKEN_EXPIRE_MINUTES как параметр

**План**: Использовать Pydantic Settings с аннотированной типизацией, вложенные переменные с разделителем `__` (например, `JWT__SECRET_KEY`, `JWT__ACCESS_TOKEN_EXPIRE_MINUTES`)

**Результат**: ✅ PASS

#### ✅ V. Чистая архитектура
**Архитектура функции**:
- **Controllers**: `app/api/v1/controllers/auth.py` (эндпоинты auth, logout)
- **Services**: `app/services/auth_service.py` (бизнес-логика аутентификации, валидация, генерация токена)
- **CRUD**: `app/db/crud/blacklisted_tokens.py` (CRUD для отзыва токенов)
- **Models**: `app/db/models/blacklisted_token.py` (модель для отозванных токенов)

**Результат**: ✅ PASS

#### ✅ VI. Абстракция базовых классов
- **BaseDBModel**: BlacklistedToken наследуется от BaseDBModel
- **BaseCrud[BlacklistedToken]**: CRUD для blacklisted токенов
- **BaseService**: AuthService наследуется от BaseService
- **BaseSchema**: Auth схемы наследуются от BaseSchema

**Результат**: ✅ PASS

#### ✅ VII. Управление сессиями БД
- Использовать `connector.get_session()` в контроллерах
- Коннектор автоматически выберет правильный URI для PYTEST

**Результат**: ✅ PASS

#### ✅ VIII. Требования к тестированию
**План тестирования**:
- Использовать pytest-asyncio для асинхронных тестов
- Генерировать тестовые данные через Faker
- Использовать Pydantic модели для тестовых данных
- Добавить фикстуры в `conftest.py` для auth токенов
- Группировать тесты через pytest.mark (auth, authorization)
- Стремиться к максимальному покрытию (--cov-branch)
- Тесты зеркалят структуру `app/`

**Обязательный рабочий процесс**:
1. Проверить наличие тестов для auth/authorization
2. Написать тесты одновременно с кодом
3. Запустить `make test` после изменений
4. Запустить `pre-commit run --all-files`

**Результат**: ✅ PASS

#### ✅ IX. Стандарты качества кода
- **Ruff**: Полный набор правил
- **MyPy**: С плагином Pydantic
- **Форматирование**: Одинарные кавычки, пробельные отступы, 100 символов
- **Докстринги**: Google-style, только на русском

**Результат**: ✅ PASS

#### ✅ X. Дисциплина scoped-разработки
**Scope функции**:
- Только аутентификация, logout, базовая авторизация
- НЕ refresh токены (предположение #8)
- НЕ rate limiting (предположение #9)
- НЕ отслеживание всех активных сессий (предположение #5)

**Результат**: ✅ PASS

#### ✅ XI. Документация и локализация
- Все .md файлы на русском языке
- Docstring на русском языке (Google-style)
- Валидационные ошибки локализованы на русский

**Результат**: ✅ PASS

#### ✅ XII. Принципы проектирования API
- Главный роутер: `app/api/router.py` включит auth роутер
- Версионирование: префикс `/v1`
- Модульный роутер: `app/api/v1/controllers/auth.py`
- Использовать HTTP статусы из `starlette.status`
- Контроллеры вызывают методы сервиса

**Результат**: ✅ PASS

#### ✅ XIII. Git-ветвление
- Ветка `005-authenticate-user` (сквозная нумерация)
- Продолжает нумерацию предыдущих фич

**Результат**: ✅ PASS

#### ✅ XIV. SQLAlchemy
- Использовать `insert()` для массовых вставок
- Использовать `select()` вместо `query()`

**Результат**: ✅ PASS

#### ✅ XV. Дополнительная документация openapi не нужна
- FastAPI генерирует автоматически
- Не тестировать openapi спецификацию

**Результат**: ✅ PASS

#### ✅ XVI. Конфигурация окружений
- Окружения: LOCAL, DEV, STAGE, PROD, PYTEST
- Каждый имеет свою конфигурацию JWT через переменные окружения

**Результат**: ✅ PASS

#### ✅ XVII. Код-стиль
- Использовать именованные аргументы
- Тексты сообщений хранить в Enum
- Импорты на уровне модуля

**Результат**: ✅ PASS

#### ✅ XVIII. Сервисный слой
- Сервисы используют Pydantic схемы для аргументов
- Сервисы передают данные в CRUD через `model_dump()`

**Результат**: ✅ PASS

### Итоговая оценка

**Результат**: ✅ ALL PASS - Продолжаем к Phase 0

## Структура проекта

### Документация (эта функция)

```text
specs/005-authenticate-user/
├── spec.md              # Спецификация функции
├── plan.md              # Этот файл (вывод команды /speckit.plan)
├── research.md          # Phase 0 вывод (команда /speckit.plan)
├── data-model.md        # Phase 1 вывод (команда /speckit.plan)
├── quickstart.md        # Phase 1 вывод (команда /speckit.plan)
├── contracts/           # Phase 1 вывод (команда /speckit.plan)
│   ├── auth.http        # HTTP контракты для аутентификации
│   └── openapi.yaml     # OpenAPI спецификация (автогенерируемая FastAPI)
├── checklists/          # Чеклисты качества
│   └── requirements.md  # Чеклист качества требований
└── tasks.md             # Phase 2 вывод (команда /speckit.tasks - НЕ создаётся /speckit.plan)
```

### Исходный код (корень репозитория)

```text
app/
├── api/
│   ├── v1/
│   │   ├── controllers/
│   │   │   ├── auth.py          # НОВЫЙ: эндпоинты auth, logout
│   │   │   └── users.py         # СУЩЕСТВУЮЩИЙ: (без изменений)
│   │   ├── router.py            # ОБНОВИТЬ: добавить auth роутер
│   │   └── schemas/
│   │       ├── auth.py          # НОВЫЙ: схемы для auth (запрос/ответ токена)
│   │       └── users.py         # СУЩЕСТВУЮЩИЙ: (без изменений)
│   └── router.py                # ОБНОВИТЬ: включить v1/auth
│
├── db/
│   ├── models/
│   │   ├── user.py              # СУЩЕСТВУЮЩИЙ: (без изменений)
│   │   ├── blacklisted_token.py # НОВЫЙ: модель для отозванных токенов
│   │   └── __init__.py          # ОБНОВИТЬ: импортировать BlacklistedToken
│   ├── crud/
│   │   ├── users.py             # СУЩЕСТВУЮЩИЙ: (без изменений)
│   │   ├── blacklisted_tokens.py # НОВЫЙ: CRUD для blacklisted токенов
│   │   └── base.py              # СУЩЕСТВУЮЩИЙ: (без изменений)
│   └── session.py               # СУЩЕСТВУЮЩИЙ: (без изменений)
│
├── services/
│   ├── auth_service.py          # НОВЫЙ: бизнес-логика аутентификации
│   ├── user_service.py          # СУЩЕСТВУЮЩИЙ: (без изменений)
│   └── base.py                  # СУЩЕСТВУЮЩИЙ: (без изменений)
│
├── api/
│   └── utils/
│       └── enums/
│           └── auth.py          # НОВЫЙ: Enum'ы для сообщений об ошибках auth
│
└── config.py                    # ОБНОВИТЬ: добавить JWT конфигурацию

tests/
├── api/
│   └── v1/
│       └── controllers/
│           └── test_auth.py     # НОВЫЙ: тесты auth endpoints
├── services/
│   └── test_auth_service.py     # НОВЫЙ: тесты auth service
└── conftest.py                  # ОБНОВИТЬ: добавить фикстуры для auth

migrations/versions/
└── 005_add_blacklisted_tokens.py # НОВАЯ: миграция для BlacklistedToken таблицы
```

**Решение по структуре**: Выбрана структура web-приложения (backend API). Новые файлы добавляются в существующую архитектуру, следуя принципам чистой архитектуры из конституции (Controller → Service → CRUD → DB). Все изменения инкрементальны и обратно совместимы.

---

## Повторная проверка конституции (после Phase 1 дизайна)

*GATE: Повторная проверка после завершения Phase 1 дизайна.*

### Решения Phase 1 и их соответствие конституции

#### ✅ Библиотека JWT: python-jose[cryptography]

**Проверка по конституции**:
- Принцип I (Технологический стек): ✅ Python-совместимая библиотека
- Принцип X (Scoped-разработка): ✅ Минимум зависимостей, только JWT
- Принцип XV (OpenAPI): ✅ Не требует дополнительной документации

**Результат**: ✅ PASS

#### ✅ Алгоритм подписи: HS256

**Проверка по конституции**:
- Принцип X (Scoped-разработка): ✅ Достаточен для single-service, без избыточности
- Принцип VI (Абстракция): ✅ Не усложняет архитектуру

**Результат**: ✅ PASS

#### ✅ Модель BlacklistedToken

**Проверка по конституции**:
- Принцип V (Чистая архитектура): ✅ Следует слоям Models → CRUD → Service
- Принцип VI (Абстракция): ✅ Наследуется от BaseDBModel, использует BaseCrud
- Принцип XIV (SQLAlchemy): ✅ Использует `select()` для чтения

**Результат**: ✅ PASS

#### ✅ Pydantic схемы (AuthRequest, AuthResponse)

**Проверка по конституции**:
- Принцип I (Технологический стек): ✅ Pydantic V2 с Annotated типизацией
- Принцип III (Type Annotations): ✅ Строгая типизация
- Принцип XI (Документация): ✅ Локализованные сообщения на русском

**Результат**: ✅ PASS

#### ✅ Dependency Injection для авторизации

**Проверка по конституции**:
- Принцип II (Dependency Injection): ✅ FastAPI Depends для get_current_user
- Принцип V (Чистая архитектура): ✅ Контроллеры → Depends → Service

**Результат**: ✅ PASS

#### ✅ Конфигурация JWT через Pydantic Settings

**Проверка по конституции**:
- Принцип IV (Управление конфигурацией): ✅ Pydantic Settings с `__` разделителем
- Принцип XVI (Конфигурация окружений): ✅ Разные значения для LOCAL/DEV/PROD/PYTEST

**Результат**: ✅ PASS

#### ✅ Локализация через Enum

**Проверка по конституции**:
- Принцип XVII (Код-стиль): ✅ Тексты сообщений в Enum
- Принцип XI (Документация): ✅ Русскоязычные сообщения

**Результат**: ✅ PASS

#### ✅ Тестирование: Real tokens в fixtures

**Проверка по конституции**:
- Принцип VIII (Тестирование): ✅ Pydantic модели для тестовых данных
- Принцип VIII (Тестирование): ✅ Фикстуры в conftest.py
- Принцип VIII (Тестирование): ✅ Покрытие ветвлений (--cov-branch)

**Результат**: ✅ PASS

### Итоговая оценка Phase 1

**Результат**: ✅ ALL PASS - Продолжаем к Phase 2 (tasks.md)

---

## Артефакты Phase 0 и Phase 1

### Phase 0: Исследование (research.md)

✅ **Завершено** - Все технические неизвестные разрешены:

1. Библиотека JWT: **python-jose[cryptography]**
2. Алгоритм подписи: **HS256**
3. JWT payload: **user_id, exp, iat, sub, is_active**
4. Механизм отзыва: **Blacklist в БД**
5. Хранение ключа: **JWT__SECRET_KEY env var**
6. Длина сессии: **JWT__ACCESS_TOKEN_EXPIRE_MINUTES**
7. Проверка is_active: **Из токена + blacklist**
8. Авторизация: **Dependency Injection**
9. Локализация: **Enum с сообщениями**
10. Тестирование: **Real tokens в fixtures**

### Phase 1: Дизайн (data-model.md, contracts/, quickstart.md)

✅ **Завершено** - Все артефакты дизайна созданы:

1. **data-model.md**: Описание модели BlacklistedToken, JWT payload, Pydantic схемы
2. **contracts/auth.http**: HTTP контракты для auth, logout, защищённых эндпоинтов
3. **quickstart.md**: Инструкции для локального запуска и тестирования
4. **Agent context**: Обновлён для новой технологии (JWT)

---

## Следующие шаги (Phase 2)

Команда для генерации задач имплементации:

```bash
/speckit.tasks
```

Это создаст файл `specs/005-authenticate-user/tasks.md` с разбивкой на конкретные задачи для разработки, упорядоченные по зависимостям и приоритетам.

---

## Статус плана

**Phase 0** (Исследование): ✅ Завершено
**Phase 1** (Дизайн): ✅ Завершено
**Phase 2** (Задачи): Ожидает `/speckit.tasks`

**Готовность к имплементации**: ✅ Да
**Проверка конституции**: ✅ ALL PASS (до и после Phase 1)