# Спецификация функции: Аутентификация и авторизация пользователей

**Фича-ветка**: `005-authenticate-user`
**Создана**: 2025-02-06
**Статус**: Черновик
**Входные данные**: Описание пользовательских историй из specs/spec_prompts/specify_prompt.md

## Сценарии использования и тестирование *(обязательный раздел)*

### Пользовательская история 1 - Аутентификация (Приоритет: P1)

**Как пользователь системы**, я хочу аутентифицироваться с помощью моего email и пароля, чтобы пользоваться системой.

**Почему этот приоритет**: Аутентификация - это фундаментальное требование для доступа к системе. Без неё невозможно реализовать авторизацию, и система не сможет различать разных пользователей или защищать конфиденциальные операции.

**Независимая проверка**: Может быть полностью протестирована путём попытки аутентификации с валидными учетными данными и получения токена, затем попытки с неверными учетными данными и получения соответствующей ошибки. Доставляет безопасный контроль доступа как автономную ценность.

**Сценарии приемки**:

1. **Дано** зарегистрированный пользователь с валидными учетными данными существует, **Когда** он отправляет правильный email и пароль, **Тогда** система успешно аутентифицирует его и возвращает валидный токен доступа
2. **Дано** пользователь пытается аутентифицироваться, **Когда** email не существует в системе, **Тогда** система возвращает ошибку, указывающую на неудачу аутентификации, не раскрывая, существует ли email
3. **Дано** зарегистрированный пользователь существует, **Когда** он отправляет неверный пароль, **Тогда** система возвращает ошибку аутентификации, не раскрывая, неверен ли пароль
4. **Дано** деактивированная учётная запись пользователя, **Когда** он пытается аутентифицироваться с валидными учетными данными, **Тогда** система запрещает доступ и возвращает ошибку, указывающую, что учётная запись неактивна
5. **Дано** пользователь успешно аутентифицировался, **Когда** токен выдан, **Тогда** токен содержит достаточно информации для идентификации пользователя и проверки его активного статуса

---

### Пользовательская история 2 - Выход из системы (Приоритет: P2)

**Как пользователь системы**, я хочу разлогиниться из системы, чтобы прервать сессию использования системы.

**Почему этот приоритет**: Выход из системы даёт пользователям контроль над жизненным циклом их сессии и является лучшей практикой безопасности. Хотя одна только аутентификация обеспечивает базовый доступ, выход завершает управление сессией пользователя. P2, потому что система может функционировать без него, но ожидания безопасности пользователей требуют этого.

**Независимая проверка**: Может быть полностью протестирована путём аутентификации для получения токена, затем вызова выхода и проверки того, что токен недействителен для последующих операций. Доставляет завершение сессии как автономную ценность.

**Сценарии приемки**:

1. **Дано** аутентифицированный пользователь с валидным токеном, **Когда** он инициирует выход из системы, **Тогда** система завершает его сессию и аннулирует его токен
2. **Дано** пользователь вышел из системы, **Когда** он пытается использовать аннулированный токен, **Тогда** система запрещает доступ и возвращает ошибку аутентификации
3. **Дано** неаутентифицированный запрос, **Когда** предпринимается попытка выхода, **Тогда** система возвращает ошибку аутентификации

---

### Пользовательская история 3 - Базовая авторизация (Приоритет: P3)

**Как авторизованный пользователь системы**, я хочу иметь возможность пользоваться инструментами системы, чтобы иметь все операции над пользователями.

**Почему этот приоритет**: Авторизация защищает конфиденциальные операции и обеспечивает надлежащий контроль доступа. P3, потому что она строится поверх аутентификации (P1) и обеспечивает уровень безопасности, который делает аутентификацию значимой в контексте системных операций.

**Независимая проверка**: Может быть полностью протестирована путём попытки доступа к защищенным эндпоинтам с валидными токенами аутентификации и без них, а также проверки того, что деактивированные пользователи не могут получать доступ к защищенным операциям даже с валидными токенами. Доставляет контроль доступа как автономную ценность.

**Сценарии приемки**:

1. **Дано** аутентифицированный активный пользователь, **Когда** он обращается к любой операции системы, **Тогда** система разрешает доступ к операции
2. **Дано** неаутентифицированный пользователь (без токена), **Когда** он пытается получить доступ к любой операции, кроме регистрации и аутентификации, **Тогда** система запрещает доступ и возвращает ошибку аутентификации
3. **Дано** аутентифицированный пользователь, чья учётная запись деактивирована во время активной сессии, **Когда** он пытается выполнить любую защищённую операцию, **Тогда** система запрещает доступ и возвращает ошибку авторизации
4. **Дано** эндпоинты регистрации и аутентификации, **Когда** неаутентифицированные пользователи обращаются к ним, **Тогда** система разрешает доступ без требования аутентификации

---

### Граничные случаи

- Что происходит, когда пользователь пытается аутентифицироваться с некорректными или отсутствующими учетными данными?
- Как система обрабатывает одновременные запросы на аутентификацию от одного и того же пользователя?
- Что происходит, когда токен истекает во время активной сессии пользователя?
- Как себя ведёт система, когда пользователь деактивирован, пока существует несколько активных сессий?
- Что происходит, когда выход вызывается несколько раз для одной и той же сессии?
- Как система обрабатывает попытки аутентификации с ограничением частоты запросов или защитой от brute force?
- Что происходит, когда предъявляется токен, который был выдан до деактивации пользователя?

## Требования *(обязательный раздел)*

### Функциональные требования

**Требования к аутентификации:**

- **FR-001**: Система ДОЛЖНА аутентифицировать пользователей путём проверки совпадения их email и пароля с сохранёнными учетными данными
- **FR-002**: Система ДОЛЖНА выдавать токен доступа с ограниченным сроком действия при успешной аутентификации
- **FR-003**: Система ДОЛЖНА запрещать аутентификацию, когда email не существует, пароль неверен или учётная запись пользователя деактивирована
- **FR-004**: Система ДОЛЖНА возвращать соответствующие сообщения об ошибках при неудачной аутентификации, не раскрывая конкретных деталей о том, существует ли email или неверен ли пароль (лучшая практика безопасности)
- **FR-005**: Система ДОЛЖНА проверять, что все требуемые учетные данные для аутентификации присутствуют и правильно отформатированы

**Требования к выходу из системы:**

- **FR-006**: Система ДОЛЖНА завершать сессии пользователей при запросе на выход
- **FR-007**: Система ДОЛЖНА аннулировать токен доступа, связанный с вышедшей из системы сессией
- **FR-008**: Система ДОЛЖНА требовать валидную аутентификацию для обработки запросов на выход
- **FR-009**: Система ДОЛЖНА возвращать подтверждение успешного выхода из системы

**Требования к авторизации:**

- **FR-010**: Система ДОЛЖНА требовать валидную аутентификацию для всех операций, кроме эндпоинтов регистрации и аутентификации
- **FR-011**: Система ДОЛЖНА проверять, что у аутентифицированных пользователей активный статус учётной записи перед разрешением доступа к защищённым операциям
- **FR-012**: Система ДОЛЖНА запрещать доступ к защищённым операциям для пользователей с неактивными учётными записями, даже с валидными токенами
- **FR-013**: Система ДОЛЖНА разрешать неаутентифицированный доступ только к эндпоинтам регистрации и аутентификации
- **FR-014**: Система ДОЛЖНА проверять валидность токена (не истёк, не отозван) при каждом запросе к защищённой операции

**Требования безопасности:**

- **FR-015**: Система НЕ ДОЛЖНА раскрывать, существует ли email в системе, при неудачах аутентификации
- **FR-016**: Система ДОЛЖНА включать информацию об идентификации пользователя и активном статусе в выдаваемые токены
- **FR-017**: Система ДОЛЖНА обеспечивать истечение срока действия токена для ограничения окна потенциального злоупотребления
- **FR-018**: Система ДОЛЖНА обрабатывать все сбои аутентификации и авторизации с помощью универсальных сообщений об ошибках

### Ключевые сущности

- **Учётная запись пользователя**: Представляет пользователя системы с учетными данными аутентификации; включает email, хэш пароля и активный статус; может находиться в активном или деактивированном состоянии
- **Токен доступа**: Представляет предоставление авторизации, выданное после успешной аутентификации; содержит идентификацию пользователя, активный статус на момент выдачи и время истечения; может быть валидным или аннулированным (отозванным)
- **Сессия**: Представляет активное состояние аутентифицированного пользователя; привязана к конкретному токену доступа; может быть активной или завершённой
- **Запрос на аутентификацию**: Содержит учетные данные пользователя (email и пароль), отправленные для аутентификации
- **Запрос на выход**: Ссылается на активную сессию, которую нужно завершить

## Критерии успеха *(обязательный раздел)*

### Измеримые результаты

- **SC-001**: Пользователи могут успешно аутентифицироваться с валидными учетными данными в течение 2 секунд
- **SC-002**: 100% неавторизованных запросов к защищённым операциям отклоняются
- **SC-003**: 100% попыток аутентификации с деактивированными учётными записями отклоняются
- **SC-004**: Выход из системы аннулирует сессии немедленно, с 100% отклонением последующих запросов с использованием аннулированных токенов
- **SC-005**: Неудачные попытки аутентификации возвращают универсальные сообщения об ошибках (без утечки информации о существовании учётной записи)
- **SC-006**: Валидные токены содержат всю необходимую информацию для проверки идентификации пользователя и активного статуса
- **SC-007**: Эндпоинты регистрации и аутентификации остаются доступными для неаутентифицированных пользователей (100% доступности без аутентификации)

## Предположения

1. Учётные записи пользователей с email и паролем уже существуют в системе (из функции регистрации)
2. Пароли хранятся с использованием безопасного хеширования (уже реализовано в предыдущих функциях)
3. Система следует принципам аутентификации без состояния с использованием токенов (отраслевой стандарт для REST API)
4. Истечение срока действия токена следует разумным временным рамкам (отраслевой стандарт: от часов до дней)
5. Системе не нужно отслеживать все активные сессии одновременно для базовой функциональности
6. Email является уникальным идентификатором учётных записей пользователей
7. Деактивированные пользователи - это валидное состояние, которое можно переключить (уже реализовано)
8. Система не требует функциональности refresh токенов для этого MVP (может быть добавлена позже)
9. Ограничение частоты запросов для попыток аутентификации выходит за рамки этой функции (может быть добавлено как уровень инфраструктуры)
10. Формат токена следует отраслевым стандартам (например, JWT), но конкретный формат - это деталь реализации

## Зависимости

- Существующая система управления пользователями (регистрация, CRUD операции над пользователями)
- Существующая модель учётной записи пользователя с полями email, хэш пароля и is_active
- Функциональность хеширования паролей (уже реализована)
